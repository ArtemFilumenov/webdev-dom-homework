<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id = 'list'>
        <!-- Список комментариев пользователей -->
      </ul>
      <div class="add-form">
        <input
          type="text" 
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input" 
          required
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="text-input"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="addCommentButton">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error {
      background-color: red;
    }
  </style>
  <script>
    //Обработчики событий
    const buttonElement = document.getElementById("addCommentButton");
    const listElement = document.getElementById("list");
    const nameInputElement = document.getElementById("name-input");
    const textInputElement = document.getElementById("text-input");

        const fetchPromise = fetch(
      'https://wedev-api.sky.pro/api/todos',
      {
        method: "GET",
      }
    );

    fetchPromise.then((response) => {

      const jsonPromise = response.json();

      jsonPromise.then((responseData) => {
        console.log(responseData);
        users = responseData.todos;
        renderUsers();
      });
    });

    //массив пользователей
    const users = [
      {
        name: 'Глеб Фокин',
        date: '12.02.22 12:18',
        comment: 'Это будет первый комментарий на этой странице',
        likes: 3,
        isLiked: false,
        id: 1,

      },
      {
        name: 'Варвара Н.',
        date: '13.02.22 19:22',
        comment: 'Мне нравится как оформлена эта страница! ❤',
        likes: 75,
        isLiked: true,
        id: 2,
      },
    ];

    //HTML разметка комментария
    const renderUsers = () => {
      const usersHtml = users.map((item) => {
        return `<li class="comment">
                  <div class="comment-header">
                    <div class="user-name">${item.name}</div>
                    <div>${item.date}</div>
                  </div>
                  <div data-text="${item.comment}" class="comment-body">
                    <div class="comment-text">
                      ${item.comment}
                    </div>
                  </div>
                  <div class="comment-footer">
                    <div class="likes">
                      <span class="likes-counter">${item.likes}</span>
                      <button data-like="${item.likes}" data-id="${item.id}" class="like-button ${item.isLiked ? '-active-like' : 'like-button'}"></button>
                    </div>
                  </div>
                </li>`;
      }).join('');

      listElement.innerHTML = usersHtml;

      initLikeButtonListeners();
      answerComment ();
    };

    renderUsers();

    //функция лайков
    function initLikeButtonListeners () {
      const buttonElements = document.querySelectorAll('.like-button');
      for (const buttonElement of buttonElements) {

        const id = buttonElement.dataset.id;
        const counter = buttonElement.dataset.like;

        buttonElement.addEventListener('click', (el) => {
          el.stopPropagation();
          const found = users.find(item => item.id === + id);
          if (found.isLiked === false) {
            const result = Number(counter) + 1;
            found.likes = result;
            found.isLiked = true;
          } else if (found.isLiked === true) {
            const result = Number(counter) - 1;
            found.likes = result;
            found.isLiked = false;
          }
          renderUsers();

        });
      }
    }

    //функция формата реального времени
    function clock() {
      let fullDate = new Date().toLocaleDateString([], { day: "2-digit", month: "2-digit", year: "2-digit" }) + " " + new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      return fullDate;
    }

    //Обработчик клика и проверка ввода
    buttonElement.addEventListener('click', () => {
      nameInputElement.classList.remove("error");
      textInputElement.classList.remove("error");
      if (!textInputElement.value.trim() || !nameInputElement.value.trim()) {
        textInputElement.classList.add("error") || nameInputElement.classList.add("error");
        return;        
      }

      //Вввод нового комментария
      const lastIndex = users.length - 1;
      const lastUserId = users[lastIndex]['id']
      console.log(lastUserId);
      users.push({
        name: nameInputElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
        date: clock(),
        comment: textInputElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
        likes: 0,
        isLiked: false,
        id: lastUserId + 1,
      })

      renderUsers();

      //Очистка форм input
      nameInputElement.value = "";
      textInputElement.value = "";
    });

    //Функция ответа на комментарий
    function answerComment () {
      const commentBlocks = document.querySelectorAll('.comment-body');
      for (const commentBlock of commentBlocks) {
        commentBlock.addEventListener('click', (event) => {
          const userNames = document.querySelectorAll('.user-name');
          console.log(event);
          textInputElement.value = `< ${event.target.outerText} \n ${event.target.parentElement.parentElement.firstElementChild.firstElementChild.innerText},`;
        });
      
      }
    }
    answerComment ()
    // Код писать здесь
    console.log("It works!");
  </script>
</html>